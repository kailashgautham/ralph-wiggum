# Progress Tracker
# Each completed task is logged here by the agent.
# Format: [DONE] Task description

[DONE] Extract the COMPLETE-handling block into a shared ralph_handle_complete() function in ralph-lib.sh: both ralph.sh (lines 206–228) and ralph-once.sh (lines 132–151) contain nearly identical logic that detects <promise>COMPLETE</promise> in OUTPUT, calls ralph_run_planning_call with the planning prompt, archives progress.txt to logs/, resets progress.txt to its header, and conditionally commits via ralph_commit_push_pr; extract this logic into a single ralph_handle_complete() function in ralph-lib.sh that accepts an iteration-label string parameter (e.g. "iteration $i" or "single iteration") used in the commit message and log output, and replace both duplicated blocks in ralph.sh and ralph-once.sh with calls to the new function
[DONE] Add a RALPH_PLAN_PROMPT environment variable to allow users to override the planning prompt without editing source files: ralph.sh (line 212) and ralph-once.sh (line 136) both hardcode the same planning prompt string; move this string into ralph-lib.sh as a module-level default (RALPH_DEFAULT_PLAN_PROMPT), then in ralph_handle_complete() (or wherever ralph_run_planning_call is invoked) use ${RALPH_PLAN_PROMPT:-$RALPH_DEFAULT_PLAN_PROMPT} so users can supply a custom planning prompt via the environment; document RALPH_PLAN_PROMPT in ralph.sh --help, ralph-once.sh --help, docker-ralph.sh --help, README.md's environment variables table, and add it to docker-ralph.sh's ENV_ARGS forwarding block
[DONE] Make docker-ralph.sh status and --dry-run call ralph.sh directly on the host instead of building the Docker image: lines 165–175 of docker-ralph.sh run docker build and docker run purely to execute ralph.sh status or ralph.sh --dry-run, which are read-only operations that require no container sandbox; replace this block with a direct exec of ralph.sh (resolved relative to docker-ralph.sh's own directory via dirname) so that status and dry-run are instant; if ralph.sh is not found in the same directory, print an error and exit 1
[DONE] Add a test verifying that RALPH_LOG_KEEP=N actually deletes old log files beyond the keep limit: tests 8 and 9 only verify that RALPH_LOG_KEEP=0 and RALPH_LOG_KEEP=abc pass/fail input validation; add a new test that pre-populates the logs/ directory of a setup_repo with more dummy .log files than the keep limit (e.g. 5 files when RALPH_LOG_KEEP=3), runs ralph.sh 1 with a mock no-op claude, and asserts that the logs/ directory contains exactly RALPH_LOG_KEEP log files (plus the one just written) and that the oldest dummy files were removed
[DONE] Add a test that verifies the prompt.txt override is used instead of the default prompt: both ralph.sh and ralph-once.sh read prompt.txt from the project root when it exists and pass its contents to claude, but no test exercises this path; add a test that creates a prompt.txt with a recognisable sentinel string in a setup_repo directory, installs a mock claude that writes its -p argument to a capture file, runs ralph.sh 1 (or ralph-once.sh), and asserts that the captured prompt equals the sentinel from prompt.txt and does not contain the default prompt text
[DONE] Add a RALPH_COMPLETE_HOOK environment variable that executes a user-supplied shell command when ralph.sh exits via any of its three terminal paths (COMPLETE, stall limit reached, or max iterations reached): operators running long unattended loops have no notification mechanism; when RALPH_COMPLETE_HOOK is set, export RALPH_EXIT_REASON (set to "complete", "stall", or "max_iterations" as appropriate) and run eval "$RALPH_COMPLETE_HOOK" immediately before each exit so the hook can distinguish outcomes; document RALPH_COMPLETE_HOOK and RALPH_EXIT_REASON in ralph.sh --help, docker-ralph.sh --help, and README.md
[DONE] Fix docker-ralph.sh cleanup to avoid word-splitting when passing container and image IDs to docker rm and docker rmi: lines 128 and 145 use 'docker rm -f $CONTAINERS' and 'docker rmi $DANGLING' where CONTAINERS and DANGLING are newline-separated strings held in plain variables; replace these with mapfile-based arrays (mapfile -t arr < <(docker ps -a ...)) and expand as "${arr[@]}" so each ID is a separate argument and the commands remain correct even if Docker ever returns IDs containing unexpected whitespace
[DONE] Move _ralph_fire_hook into ralph-lib.sh and add RALPH_COMPLETE_HOOK support to ralph-once.sh: _ralph_fire_hook is currently defined only in ralph.sh (lines 127–132) and is never called in ralph-once.sh, meaning RALPH_COMPLETE_HOOK never fires when using ralph-once.sh even on its terminal COMPLETE exit path; move the function definition verbatim into ralph-lib.sh (so both scripts source it), then in ralph-once.sh call _ralph_fire_hook "complete" immediately before the exit 0 in the COMPLETE detection block (line 136); also update the ralph-once.sh --help ENV block to document RALPH_COMPLETE_HOOK and RALPH_EXIT_REASON in the same style as ralph.sh --help
[DONE] Fix log rotation to avoid ls piped to xargs: ralph.sh line 113 uses 'cd "$LOGS_DIR" && ls -t | tail -n +"$((RALPH_LOG_KEEP + 1))" | xargs rm -f' which silently misbehaves when log filenames contain spaces and passes no arguments to xargs when the log count is within the limit (harmless but fragile); replace this block with a mapfile-based approach: read sorted-by-time filenames into an array with 'mapfile -t _log_files < <(ls -t "$LOGS_DIR")', compute excess as files beyond RALPH_LOG_KEEP, and delete only the excess entries with 'rm -f "${_log_files[@]:RALPH_LOG_KEEP}"' so the logic is correct even with whitespace in filenames and avoids the xargs edge case
[DONE] If ralph cannot run due to claude code running out of credits, pause and retry once every hour. If it works, continue looping until you run out of credits.
[DONE] Add tests for RALPH_COMPLETE_HOOK firing on each of ralph.sh's three terminal exit paths: the hook is implemented but no test verifies it actually fires or that RALPH_EXIT_REASON is set correctly; add three tests to tests/run_tests.sh — one for the "stall" path (mock claude makes no progress, RALPH_MAX_STALLS=1), one for the "max_iterations" path (mock claude makes no progress, 1 max iteration, RALPH_MAX_STALLS=99), and one for the "complete" path (mock claude outputs <promise>COMPLETE</promise>, which triggers ralph_handle_complete then a new iteration; for simplicity test that the hook fires on stall/max_iterations); each test sets RALPH_COMPLETE_HOOK to write RALPH_EXIT_REASON to a file and asserts the file contains the expected reason string
