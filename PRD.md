# Ralph Self-Improvement Plan

Ralph is a self-improving loop. Each iteration, Claude reads this file and progress.txt, picks the next uncompleted task, implements it, commits the change, and marks it done.

**Important:** If all tasks are completed, review the codebase for weaknesses and append new improvement tasks to the Tasks section below before proceeding. There should always be work to do.

## Tasks
- [ ] If ralph cannot run due to claude code running out of credits, pause and retry once every hour. If it works, continue looping until you run out of credits.
- [ ] Move _ralph_fire_hook into ralph-lib.sh and add RALPH_COMPLETE_HOOK support to ralph-once.sh: _ralph_fire_hook is currently defined only in ralph.sh (lines 127–132) and is never called in ralph-once.sh, meaning RALPH_COMPLETE_HOOK never fires when using ralph-once.sh even on its terminal COMPLETE exit path; move the function definition verbatim into ralph-lib.sh (so both scripts source it), then in ralph-once.sh call _ralph_fire_hook "complete" immediately before the exit 0 in the COMPLETE detection block (line 136); also update the ralph-once.sh --help ENV block to document RALPH_COMPLETE_HOOK and RALPH_EXIT_REASON in the same style as ralph.sh --help
- [ ] Fix log rotation to avoid ls piped to xargs: ralph.sh line 113 uses 'cd "$LOGS_DIR" && ls -t | tail -n +"$((RALPH_LOG_KEEP + 1))" | xargs rm -f' which silently misbehaves when log filenames contain spaces and passes no arguments to xargs when the log count is within the limit (harmless but fragile); replace this block with a mapfile-based approach: read sorted-by-time filenames into an array with 'mapfile -t _log_files < <(ls -t "$LOGS_DIR")', compute excess as files beyond RALPH_LOG_KEEP, and delete only the excess entries with 'rm -f "${_log_files[@]:RALPH_LOG_KEEP}"' so the logic is correct even with whitespace in filenames and avoids the xargs edge case
- [ ] Add tests for RALPH_COMPLETE_HOOK firing on each of ralph.sh's three terminal exit paths: the hook is implemented but no test verifies it actually fires or that RALPH_EXIT_REASON is set correctly; add three tests to tests/run_tests.sh — one for the "stall" path (mock claude makes no progress, RALPH_MAX_STALLS=1), one for the "max_iterations" path (mock claude makes no progress, 1 max iteration, RALPH_MAX_STALLS=99), and one for the "complete" path (mock claude outputs <promise>COMPLETE</promise>, which triggers ralph_handle_complete then a new iteration; for simplicity test that the hook fires on stall/max_iterations); each test sets RALPH_COMPLETE_HOOK to write RALPH_EXIT_REASON to a file and asserts the file contains the expected reason string
- [ ] Deduplicate retry/backoff logic in ralph_run_main_call and ralph_run_planning_call: both functions in ralph-lib.sh implement an almost identical while-loop with exponential backoff (differing only in whether output is tee'd to a tmpfile for capture or streamed directly to a log); extract a shared internal helper _ralph_invoke_claude_with_retry that accepts the claude command array and a "capture to variable" flag, runs the retry loop, and on success either sets a caller-supplied variable name (via printf -v) or streams output; rewrite ralph_run_main_call and ralph_run_planning_call as thin wrappers that build their respective cmd arrays and delegate to the helper, eliminating the duplicated while/sleep/backoff code
- [ ] Add tests for docker-ralph.sh status and --dry-run delegating to ralph.sh on the host: these two subcommands now exec ralph.sh directly without Docker, but run_tests.sh has no coverage of this path; add two tests that set up a minimal repo, provide a stub docker command that exits non-zero (to prove Docker is never invoked), and run docker-ralph.sh status / docker-ralph.sh --dry-run with PATH adjusted to include the stub; assert exit 0 and that the output contains the expected status summary or "Next task:" line respectively
- [ ] Add a RALPH_ITER_HOOK environment variable that is eval'd at the start of each iteration in ralph.sh before the Claude invocation: operators sometimes need pre-iteration setup (e.g., checking disk space, rotating credentials, printing a heartbeat to an external monitor); when RALPH_ITER_HOOK is set, export RALPH_CURRENT_ITER and RALPH_MAX_ITER then run eval "$RALPH_ITER_HOOK" at the top of the for-loop body (before ralph_run_main_call), and log a one-line notice to RUN_LOG when the hook is configured; document RALPH_ITER_HOOK, RALPH_CURRENT_ITER, and RALPH_MAX_ITER in ralph.sh --help, docker-ralph.sh --help (and its ENV_ARGS forwarding block), and README.md's environment variables table
