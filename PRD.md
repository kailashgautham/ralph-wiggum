# Ralph Self-Improvement Plan

Ralph is a self-improving loop. Each iteration, Claude reads this file and progress.txt, picks the next uncompleted task, implements it, commits the change, and marks it done.

**Important:** If all tasks are completed, review the codebase for weaknesses and append new improvement tasks to the Tasks section below before proceeding. There should always be work to do.

## Tasks
- [ ] Remove the duplicate run_claude() function from ralph.sh and replace it with a call to ralph_run_main_call() from ralph-lib.sh: ralph.sh still contains its own local run_claude() function (defined around line 215) that is nearly identical to ralph_run_main_call() added to ralph-lib.sh; the extraction task only updated ralph-once.sh but left ralph.sh with its own copy; delete run_claude() from ralph.sh, replace the call to run_claude on the loop iteration line with ralph_run_main_call "$PROMPT", and confirm that OUTPUT is still set correctly for the COMPLETE check and log write that follow
- [ ] Extract the status and --dry-run subcommand logic into shared ralph-lib.sh functions: both ralph.sh (lines 47–116) and ralph-once.sh (lines 43–112) contain verbatim copies of the same status-printing loop (mapfile, for-task, grep -qxF, COMPLETED/REMAINING arrays) and the same next-task finder; add ralph_show_status() and ralph_next_task() functions to ralph-lib.sh and replace the duplicated blocks in both scripts with calls to these functions; update the source line so ralph-once.sh sources ralph-lib.sh before the status/dry-run subcommand checks (it currently sources after the --help check but before status, which is correct, but verify)
- [ ] Fix the stall-detection exit path in ralph.sh to print the run summary: when the stall counter reaches RALPH_MAX_STALLS the script does "exit 1" without calling print_run_summary(), so the operator never sees start time, elapsed time, or iteration count on a stall-abort; call print_run_summary "stall limit reached" immediately before the "exit 1" in the stall-detection block so all three exit paths (max iterations, COMPLETE, stall) produce a summary line
- [ ] Fix the lockfile trap ordering in ralph-once.sh: the lockfile is acquired with flock on line 147 but the EXIT trap that removes it is not registered until line 168; if set -euo pipefail triggers an early exit between those two lines (e.g. from the mkdir, tee, or echo that precede the trap), the lockfile is never deleted and subsequent runs are permanently blocked; move the trap 'rm -f "$LOCKFILE"' EXIT line to immediately after the successful flock call, mirroring the ordering in ralph.sh where the trap is set right after flock
- [ ] Forward RALPH_NO_GIT into the Docker container in docker-ralph.sh: the ENV_ARGS block (around line 188) collects and forwards most Ralph environment variables but omits RALPH_NO_GIT; a user who sets RALPH_NO_GIT=1 ./docker-ralph.sh will find that git operations still run inside the container; add RALPH_NO_GIT to the ENV_ARGS forwarding block alongside the other RALPH_* variables and add it to the docker-ralph.sh --help environment variables table
- [ ] Add tests for ralph-once.sh's --dry-run and status subcommands: tests 1 and 2 in tests/run_tests.sh verify --dry-run and status for ralph.sh but there are no equivalent tests for ralph-once.sh; add two new tests that run ralph-once.sh --dry-run and ralph-once.sh status against a minimal repo (using the existing setup_repo helper) and assert the same exit codes and output patterns as tests 1 and 2
- [ ] Document RALPH_NO_PR in ralph.sh --help, ralph-once.sh --help, and README.md: the RALPH_NO_PR variable is honoured by ralph_commit_push_pr() in ralph-lib.sh and is listed in docker-ralph.sh --help, but it is absent from ralph.sh's help text, ralph-once.sh's help text, and README.md's environment variables table; add it to all three locations with the description "If non-empty, skip PR creation and leave the branch on the remote for manual review"
