# Ralph Self-Improvement Plan

Ralph is a self-improving loop. Each iteration, Claude reads this file and progress.txt, picks the next uncompleted task, implements it, commits the change, and marks it done.

**Important:** If all tasks are completed, review the codebase for weaknesses and append new improvement tasks to the Tasks section below before proceeding. There should always be work to do.

## Tasks
- [ ] Add kailash.gautham@gmail.com, Kailash Gautham as the main committer and co-authored by ralph. And use a PR and merging workflow.
- [ ] Add retry logic to the main Claude invocation in ralph-once.sh: ralph-once.sh runs Claude once and exits immediately on any non-zero exit code; unlike ralph.sh which wraps the call in a run_claude() function with up to MAX_RETRIES attempts and exponential backoff, a transient API error in ralph-once.sh aborts the entire run; replicate the same retry loop (up to MAX_RETRIES, with BACKOFF = RETRY_DELAY * 2^(attempt-1) capped at 60s) around the main Claude call in ralph-once.sh so single-iteration runs are equally resilient to transient failures
- [ ] Apply exponential backoff to the planning call retry in ralph-once.sh: the planning retry loop in ralph-once.sh (after COMPLETE is detected) sleeps a fixed RETRY_DELAY seconds between attempts, while the equivalent loop in ralph.sh already uses exponential backoff (BACKOFF = RETRY_DELAY * 2^(attempt-1), capped at 60s); update ralph-once.sh to use the same formula so both scripts behave consistently under repeated API failures
- [ ] Make the SSH key path configurable in docker-ralph.sh: the container mounts ~/.ssh/id_ed25519 unconditionally; users with rsa, ecdsa, or other key types get a cryptic Docker bind-mount error; add a RALPH_SSH_KEY env var (defaulting to ~/.ssh/id_ed25519), skip the SSH volume mount entirely when the key file does not exist, and print a clear warning so users know git push over SSH may fail
- [ ] Add a git remote check before pushing in ralph.sh and ralph-once.sh: both scripts run git push without first verifying a remote is configured; when Ralph is used in a repo with no remote, git push fails with an opaque error that looks like a bug; add a guard (git remote get-url origin 2>/dev/null) before each push and skip push with a clear informational message when no remote is set
- [ ] Make the --allowedTools list configurable via RALPH_ALLOWED_TOOLS env var: the tool set passed to Claude is hardcoded as "Edit,Write,Bash,Read,Glob,Grep" in both ralph.sh and ralph-once.sh; users who need additional tools (e.g. Task, WebFetch) must patch the scripts; read RALPH_ALLOWED_TOOLS from the environment (defaulting to the current list), forward it from docker-ralph.sh's ENV_ARGS block, and pass it to every Claude invocation so the tool set is tunable without modifying scripts
- [ ] Fix integer expression error in ralph.sh stall detection: `grep -c '^\[DONE\]' progress.txt` can output multiple lines (e.g. when progress.txt has trailing newlines or grep returns unexpected output), causing `[: 0\n0: integer expression expected` on the DONE_BEFORE/DONE_AFTER comparison at line ~180; pipe the grep through `tail -1` or use a safer pattern to ensure exactly one integer is captured
- [ ] Add temp file cleanup to the ralph.sh SIGINT/SIGTERM handler: handle_signal logs a message and calls exit, but does not remove the claude_output_$$.tmp file that run_claude() may have open at the time of the signal; orphaned tmp files accumulate in logs/ across interrupted runs; expand the trap to also rm -f "$LOGS_DIR/claude_output_"*".tmp" so the logs directory stays clean after a Ctrl-C or kill
- [ ] Add a --dry-run subcommand to ralph.sh: operators and CI pipelines often need to know which task Ralph would execute next without actually invoking Claude or modifying any files; implement ./ralph.sh --dry-run that cross-references PRD.md and progress.txt (the same logic used by the status subcommand) and prints the next uncompleted task description, then exits 0; if all tasks are complete it should print a message indicating that and exit 0 as well
- [ ] Expose RALPH_RETRY_DELAY as a configurable env var and forward it from docker-ralph.sh: RETRY_DELAY is hardcoded to 5 in both ralph.sh and ralph-once.sh; it serves as the base for exponential backoff but cannot be tuned without editing the scripts; rename it to read RALPH_RETRY_DELAY from the environment (default 5), forward it in docker-ralph.sh's ENV_ARGS block alongside the other tuning vars, and use it everywhere RETRY_DELAY currently appears
- [ ] Mount known_hosts conditionally in docker-ralph.sh: the container always mounts $HOME/.ssh/known_hosts with -v even when that file does not exist on the host; Docker treats a missing bind-mount source as an error or creates an empty directory in its place, breaking SSH connectivity silently; add a check (similar to the RALPH_SSH_KEY fix) that only adds the known_hosts volume argument when the file exists, and print a warning when it is absent so users understand that SSH host verification may fail inside the container
- [ ] Make max iterations configurable via RALPH_MAX_ITERATIONS env var: the default iteration cap in ralph.sh is hardcoded as MAX=${1:-20} and cannot be changed without passing a positional argument; add a RALPH_MAX_ITERATIONS env var (defaulting to 20) that is read when no positional argument is given, and forward it from docker-ralph.sh's ENV_ARGS block alongside the other tuning vars so the cap is tunable via environment without modifying the scripts or changing how docker-ralph.sh calls ralph.sh
- [ ] Add --verbose flag to planning call in ralph-once.sh for consistency with ralph.sh: the PLAN_CMD in ralph-once.sh (constructed after COMPLETE is detected) does not include --verbose, while the equivalent PLAN_CMD in ralph.sh does; this means planning output from ralph-once.sh is less detailed than from ralph.sh; add --verbose to the PLAN_CMD array in ralph-once.sh so both scripts produce consistent planning output
- [ ] Make base branch name configurable via RALPH_BASE_BRANCH env var: both ralph.sh and ralph-once.sh hardcode "main" in git checkout and git pull commands (e.g. git checkout main, git pull --ff-only origin main); repos that use "master" or a custom trunk branch will fail at these steps with a cryptic git error; add a RALPH_BASE_BRANCH env var (defaulting to "main"), forward it from docker-ralph.sh's ENV_ARGS block, and replace all hardcoded "main" references in the git checkout and git pull commands in both scripts
- [ ] Rename MAX_RETRIES env var to RALPH_MAX_RETRIES for consistent naming convention: all other user-facing tuning variables use the RALPH_ prefix (RALPH_TIMEOUT, RALPH_MAX_STALLS, RALPH_RETRY_DELAY, RALPH_ALLOWED_TOOLS) but MAX_RETRIES does not; update both scripts to read RALPH_MAX_RETRIES from the environment (with MAX_RETRIES accepted as a fallback for backwards compatibility), update docker-ralph.sh to forward RALPH_MAX_RETRIES in its ENV_ARGS block, and update any documentation references
